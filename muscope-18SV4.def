Bootstrap: docker
From: ubuntu:latest

%runscript

    echo "Failte!"

%post

   apt update
   # try leaving this to the python-dev install
   apt install -y git wget 
   
   apt install -y python-dev python-pip
   # see http://stackoverflow.com/questions/36394101/pip-install-locale-error-unsupported-locale-setting
   export LC_ALL=C  # needed for pip but why?
   pip install --upgrade pip

   # I know these will be needed
   # is it really necessary to install numpy first?
   # I have had trouble with pycogent refusing to install because it does not recognize numpy
   # but the following two-step install seems to work
   pip install numpy
   pip install qiime

   # this resolves and issue with qiime --> matplotlib --> qt5
   # try without this for install without anaconda
   ##apt install -y libgl1-mesa-glx

   export APP_DIR=/mu18SV4
   mkdir -p $APP_DIR
   cd $APP_DIR

   #wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
   #export MINICONDA=$APP_DIR/miniconda
   #bash /tmp/miniconda.sh -b -p $MINICONDA
   #rm /tmp/miniconda.sh
   #export MINICONDA_PATH=$MINICONDA/bin
   #export PATH=$MINICONDA_PATH:$PATH
   #conda update --yes conda
   #echo "installed miniconda"
   #echo "  PATH=${PATH}"

   git clone https://github.com/hurwitzlab/muscope-18SV4.git
   cd muscope-18SV4
   git checkout feature/primer_args
   pip install -r requirements.txt

   cd $APP_DIR
   git clone https://github.com/brwnj/fastq-join
   cd fastq-join
   make
   export FASTQ_JOIN_PATH=$APP_DIR/fastq-join
   export PATH=$FASTQ_JOIN_PATH:$PATH
   echo "installed fastq-join"
   echo "  PATH=$PATH"
   #conda install --yes --channel bioconda --file requirements.txt
   #conda install --yes --channel bioconda fastq-join=1.3.1

   # install vsearch
   cd $APP_DIR
   wget https://github.com/torognes/vsearch/releases/download/v2.4.3/vsearch-2.4.3-linux-x86_64.tar.gz -O /tmp/vsearch.tar.gz
   tar xzf /tmp/vsearch.tar.gz
   rm /tmp/vsearch.tar.gz
   mv $APP_DIR/vsearch-2.4.3-linux-x86_64 $APP_DIR/vsearch
   export VSEARCH_PATH=$APP_DIR/vsearch/bin
   export PATH=$VSEARCH_PATH:$PATH
   echo "installed vsearch"
   echo "  PATH=$PATH"

   # create mount points for TACC directories
   mkdir /home1
   mkdir /scratch
   mkdir /work

   # add environment variables to /environment file
   echo "\nexport PATH=$FASTQ_JOIN_PATH:$VSEARCH_PATH:\$PATH" >> /environment
   less /environment

%test
   export APP_DIR=/mu18SV4
   export PATH=$APP_DIR/fastq-join:$APP_DIR/vsearch/bin:$PATH

   echo "PATH=${PATH}"

   python --version
   #fastq-join
   vsearch --version
