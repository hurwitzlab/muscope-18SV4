Bootstrap: docker
From: ubuntu:latest

%runscript

    pipeline $@

%setup
    mkdir "$SINGULARITY_ROOTFS/muscope-18SV4"
    mount --no-mtab --bind `pwd` "$SINGULARITY_ROOTFS/muscope-18SV4"

%environment
    PATH=/app/fastq-join:/app/fastxtk:$PATH

%post

    apt update
    apt install -y apt-utils
    apt install -y git wget zip bzip2 python3-dev python3-pip

    export LC_ALL=C
    /usr/bin/pip3 install --upgrade pip
    # biopython wants numpy already installed why?
    /usr/bin/pip3 install numpy
    /usr/bin/pip3 install /muscope-18SV4[dev,test]

    # install trimmomatic
    apt install -y trimmomatic

    # create a directory for installed dependencies
    APP_DIR=/app
    mkdir -p $APP_DIR
    cd $APP_DIR

    # install fastq-join
    git clone https://github.com/brwnj/fastq-join
    cd fastq-join
    make

    # install fastx-toolkit
    cd $APP_DIR
    wget http://hannonlab.cshl.edu/fastx_toolkit/fastx_toolkit_0.0.13_binaries_Linux_2.6_amd64.tar.bz2
    tar xvf fastx_toolkit_0.0.13_binaries_Linux_2.6_amd64.tar.bz2
    rm fastx_toolkit_0.0.13_binaries_Linux_2.6_amd64.tar.bz2
    mv bin fastxtk

    # create mount points for TACC directories
    mkdir /home1
    mkdir /scratch
    mkdir /work

%test
    echo "PATH=${PATH}"

    python3 --version
