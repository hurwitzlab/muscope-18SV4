Bootstrap: docker
From: ubuntu:16.04

%runscript

    pipeline $@

%setup
    mkdir "$SINGULARITY_ROOTFS/muscope-18SV4"
    mount --no-mtab --bind `pwd` "$SINGULARITY_ROOTFS/muscope-18SV4"

%environment
    PATH=/app/miniconda3/bin:/app/FastQC:$PATH

%post

    apt update
    apt install -y apt-utils
    apt install -y git wget zip bzip2 python3-dev python3-pip

    mkdir /app
    cd /app

    # install miniconda
    wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda3.sh
    chmod +x miniconda3.sh
    ./miniconda3.sh -b -p /app/miniconda3
    export PATH=/app/miniconda3/bin:$PATH
    pwd
    ls -l
    conda update --yes conda
    wget https://data.qiime2.org/distro/core/qiime2-2018.4-py35-linux-conda.yml
    conda env create -n qiime2 --file qiime2-2018.4-py35-linux-conda.yml
    ## why does this fail?
    ## conda install --file qiime2-2018.4-py35-linux-conda.yml
    # OPTIONAL CLEANUP
    rm qiime2-2018.4-py35-linux-conda.yml
    /app/miniconda3/bin/activate qiime2

    # apt fastqc installation is not complete
    # /etc/fastqc/Configuration is not set up
    #apt install -y fastqc

    # install fastqc
    cd /app
    wget https://www.bioinformatics.babraham.ac.uk/projects/fastqc/fastqc_v0.11.5.zip
    unzip fastqc_v0.11.5.zip
    rm fastqc_v0.11.5.zip
    chmod a+x FastQC/fastqc

    export LC_ALL=C
    # do not upgrade pip while 10.0 is broken
    ##/usr/bin/pip3 install --upgrade pip
    # biopython wants numpy already installed why?
    /usr/bin/pip3 install numpy
    /usr/bin/pip3 install /muscope-18SV4[dev,test]

    # install trimmomatic
    apt install -y trimmomatic

    # install fastx-toolkit
    apt install -y fastx-toolkit

    # install ea-utils to get fastq-join
    apt install -y ea-utils

    # create mount points for TACC directories
    mkdir /home1
    mkdir /scratch
    mkdir /work

%test
    echo "PATH=${PATH}"

    #source /app/miniconda3/bin/activate qiime2
